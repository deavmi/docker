networks:
  quassel_db_net:
    driver: bridge
    name: quassel_db_net
    enable_ipv6: true
    ipam:
      config:
        - subnet: fde4:498b:fc7f::/48

services:
  quassel:
    image: docker.io/kalaksi/quassel
    container_name: quassel
    restart: unless-stopped
    depends_on:
      - quassel-db

    # Command-line arguments to give
    # to entrypoint executable
    command:
      - "--config-from-environment"
      - "--port=4242" # container-side port to listen on
      - "--configdir=/config"
      - "--ssl-cert=/certs/${QUASSEL_SSL_CERT_FILE}"
      - "--ssl-key=/certs/${QUASSEL_SSL_KEY_FILE}"
    environment:
      # Database-related
      - DB_BACKEND=PostgreSQL
      - DB_PGSQL_USERNAME=quassel_user
      - DB_PGSQL_PASSWORD=quassel_pass
      - DB_PGSQL_DATABASE=quassel
      - DB_PGSQL_HOSTNAME=quassel-db
      - DB_PGSQL_PORT=5432
    # Set the effective UID/GID
    # for all operations from
    # the spawned entrypoint and
    # thereon
    user: ${USER_UID}:${USER_GID}
    volumes:
      # Configuration data
      - "${QUASSEL_CORE_DATA_PATH}:/config:z"

      # SSL certificates and key
      - "${QUASSEL_SSL_DIR}:/certs:ro"
    networks:
      - mainNet
      - quassel_db_net
    ports:
      - 4242:4242

  quassel-db:
    image: postgres:latest
    container_name: quassel-db
    environment:
      - POSTGRES_USER=quassel_user
      - POSTGRES_PASSWORD=quassel_pass
      - POSTGRES_DB=quassel
    # Set the effective UID/GID
    # for all operations from
    # the spawned entrypoint and
    # thereon
    user: ${USER_UID}:${USER_GID}
    volumes:
      - "${QUASSEL_CORE_DB_PATH}:/var/lib/postgresql/data:z"
    networks:
      - quassel_db_net
