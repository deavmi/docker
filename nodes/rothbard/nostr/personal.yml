services:
  personal_db:
    image: postgres:16.4
    container_name: personal_db

    # The container will create a user with this
    # UID/GID pair. This matches MY host, make them
    # match your host. This makes files created in
    # the mountpoint easily accessible for us
    user: ${USER_UID}:${USER_GID}

    environment:
      - POSTGRES_DB=nostr
      - POSTGRES_USER=dbuser
      - POSTGRES_PASSWORD=dbpass
      - PGDATA=/var/lib/postgresql/data
    restart: unless-stopped
    network_mode: service:personal_proxy
    volumes:
      - ${NOSTR_PERSONAL_DB_PATH}:/var/lib/postgresql/data:z

  personal_relay:
    depends_on:
      - personal_db
    build:
      context: personal
    container_name: personal_relay
    restart: unless-stopped
    networks:
      ipv6_pool_net:
        ipv6_address: ${NOSTR_RELAY_PERSONAL_ADDR}
      yggdrasil_net:
        ipv6_address: ${NOSTR_RELAY_PERSONAL_ADDR_Y}
    ports:
      # Expose (firewall) on behalf of `personal_relay`
      - 7000/tcp
